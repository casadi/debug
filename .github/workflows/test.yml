name: Test CasADi

on:
  push:
  workflow_dispatch:

jobs:
  test-matlab-macos-arm64:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4.1.1

      - name: Clone CasADi repo
        run: git clone --depth 1 https://github.com/casadi/casadi.git casadi_src

      - name: Download CasADi nightly
        run: |
          wget https://github.com/casadi/casadi/releases/download/nightly-main/casadi-main-osx-arm64-matlab2018b.zip -O casadi.zip

      - name: Unpack
        run: unzip casadi.zip -d casadi

      - name: Set up MATLAB
        uses: matlab-actions/setup-matlab@v2
        with:
          release: R2025a

      - name: Run sysid with MW_CRASH_MODE=native
        continue-on-error: true
        run: |
          # Set MW_CRASH_MODE=native to get native macOS crash reports
          # This tells MATLAB to use the OS crash handler instead of its own
          export MW_CRASH_MODE=native

          echo "Starting MATLAB with MW_CRASH_MODE=$MW_CRASH_MODE"

          # Find MATLAB path
          MATLAB_PATH="/Users/runner/hostedtoolcache/MATLAB/2025.1.999/arm64/MATLAB.app/bin/matlab"

          # Run MATLAB directly with the sysid command
          $MATLAB_PATH -batch "addpath('${{ github.workspace }}/casadi'); cd('casadi_src/docs/examples/matlab'); sysid" || true

          echo "MATLAB exited, waiting for crash report to be generated..."
          sleep 10

      - name: Collect crash info
        if: always()
        run: |
          echo "=== Core dumps ==="
          ls -la /cores/ 2>/dev/null || echo "No /cores directory or empty"
          find /cores -name "core.*" 2>/dev/null | head -5 | while read f; do
            echo "=== Core dump: $f ==="
            ls -la "$f"
          done

          echo ""
          echo "=== MATLAB crash dump in home directory ==="
          find ~ -maxdepth 1 -name "matlab_crash_dump*" -mmin -30 2>/dev/null | while read f; do
            echo "=== $f ==="
            cat "$f" 2>/dev/null | head -1000
          done

          echo ""
          echo "=== MATLAB .matlab directory ==="
          find ~/.matlab -type f -mmin -30 2>/dev/null | head -20 || true

          # Check for minidump files
          find ~/.matlab -name "*.dmp" 2>/dev/null | while read f; do
            echo "=== Minidump: $f ==="
            ls -la "$f"
          done

          echo ""
          echo "=== System crash reports - .ips files ==="
          find /Library/Logs/DiagnosticReports ~/Library/Logs/DiagnosticReports -name "*.ips" -mmin -30 2>/dev/null | while read f; do
            echo "=== $f ==="
            cat "$f" 2>/dev/null | head -800
          done

          echo ""
          echo "=== System crash reports - .crash files ==="
          find /Library/Logs/DiagnosticReports ~/Library/Logs/DiagnosticReports -name "*.crash" -mmin -30 2>/dev/null | while read f; do
            echo "=== $f ==="
            cat "$f" 2>/dev/null | head -800
          done

          echo ""
          echo "=== List all diagnostic reports ==="
          ls -la /Library/Logs/DiagnosticReports/ 2>/dev/null | tail -30
          ls -la ~/Library/Logs/DiagnosticReports/ 2>/dev/null | tail -30
