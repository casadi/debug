name: Test CasADi

on:
  push:
  workflow_dispatch:

jobs:
  test-issue-4274:
    runs-on: windows-2022
    steps:
      - uses: actions/checkout@v4.1.1

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Download CasADi no_thread_local2 nightly
        run: |
          C:\msys64\usr\bin\wget.exe https://github.com/casadi/casadi/releases/download/nightly-no_thread_local2/casadi-no_thread_local2-windows64-py311.zip -O casadi.zip

      - name: Unpack
        run: unzip casadi.zip -d casadi_pkg

      - name: Install numpy
        run: pip install numpy

      - name: Test issue 4274 - thread map with IO
        run: |
          $env:PYTHONPATH = "${{ github.workspace }}\casadi_pkg"
          python test_issue_4274.py

  test-nightly:
    runs-on: windows-2022
    steps:
      - uses: actions/checkout@v4.1.1

      - name: Download CasADi nightly
        run: |
          C:\msys64\usr\bin\wget.exe https://github.com/casadi/casadi/releases/download/nightly-main/casadi-main-windows64-matlab2018b.zip -O casadi.zip

      - name: Unpack
        run: unzip casadi.zip -d casadi

      - name: Set up MATLAB
        uses: matlab-actions/setup-matlab@v2
        with:
          release: R2025a

      - name: Diag - clear mex then quit
        uses: matlab-actions/run-command@v2
        with:
          command: addpath('${{ github.workspace }}/casadi'); test_single_plugin('Integrator::rk'); clear mex; pause(1)

      - name: Diag - clear all then quit
        uses: matlab-actions/run-command@v2
        with:
          command: addpath('${{ github.workspace }}/casadi'); test_single_plugin('Integrator::rk'); clear all; pause(1)

      - name: Diag - just quit
        uses: matlab-actions/run-command@v2
        with:
          command: addpath('${{ github.workspace }}/casadi'); test_single_plugin('Integrator::rk')

  test-matlab-macos-arm64:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4.1.1

      - name: Clone CasADi repo
        run: git clone --depth 1 https://github.com/casadi/casadi.git casadi_src

      - name: Download CasADi nightly
        run: |
          wget https://github.com/casadi/casadi/releases/download/nightly-main/casadi-main-osx-arm64-matlab2018b.zip -O casadi.zip

      - name: Unpack
        run: unzip casadi.zip -d casadi

      - name: Set up MATLAB
        uses: matlab-actions/setup-matlab@v2
        with:
          release: R2025a

      - name: Create lldb wrapper for batch mode
        run: |
          mkdir -p ${{ github.workspace }}/bin
          cat > ${{ github.workspace }}/bin/lldb << 'WRAPPER'
          #!/bin/bash
          /usr/bin/lldb --batch -o "run" -k "bt all" -k "quit 1" -- "$@"
          WRAPPER
          chmod +x ${{ github.workspace }}/bin/lldb
          echo "${{ github.workspace }}/bin" >> $GITHUB_PATH

      - name: Test sysid_debug (hessLag eval before Ipopt)
        uses: matlab-actions/run-command@v2
        with:
          command: addpath('${{ github.workspace }}/casadi'); sysid_debug
          startup-options: -Dlldb

      - name: Collect crash reports
        if: failure()
        run: |
          echo "=== System crash reports ==="
          ls -la /Library/Logs/DiagnosticReports/ 2>/dev/null || true
          ls -la ~/Library/Logs/DiagnosticReports/ 2>/dev/null || true
          echo "=== Recent MATLAB crash reports ==="
          find /Library/Logs/DiagnosticReports ~/Library/Logs/DiagnosticReports -name "*MATLAB*" -mmin -10 2>/dev/null | head -5 | xargs -I{} sh -c 'echo "=== {} ===" && cat "{}"' || true

  test-v372:
    runs-on: windows-2022
    steps:
      - uses: actions/checkout@v4.1.1

      - name: Download CasADi 3.7.2
        run: |
          C:\msys64\usr\bin\wget.exe https://github.com/casadi/casadi/releases/download/3.7.2/casadi-3.7.2-windows64-matlab2018b.zip -O casadi.zip

      - name: Unpack
        run: unzip casadi.zip -d casadi

      - name: Set up MATLAB
        uses: matlab-actions/setup-matlab@v2
        with:
          release: R2025a

      - name: Diag - clear mex then quit
        uses: matlab-actions/run-command@v2
        with:
          command: addpath('${{ github.workspace }}/casadi'); test_single_plugin('Integrator::rk'); clear mex; pause(1)

      - name: Diag - clear all then quit
        uses: matlab-actions/run-command@v2
        with:
          command: addpath('${{ github.workspace }}/casadi'); test_single_plugin('Integrator::rk'); clear all; pause(1)

      - name: Diag - just quit
        uses: matlab-actions/run-command@v2
        with:
          command: addpath('${{ github.workspace }}/casadi'); test_single_plugin('Integrator::rk')
