name: Test CasADi

on:
  push:
  workflow_dispatch:

jobs:
  test-matlab-macos-arm64:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4.1.1

      - name: Clone CasADi repo
        run: git clone --depth 1 https://github.com/casadi/casadi.git casadi_src

      - name: Download CasADi nightly
        run: |
          wget https://github.com/casadi/casadi/releases/download/nightly-main/casadi-main-osx-arm64-matlab2018b.zip -O casadi.zip

      - name: Unpack
        run: unzip casadi.zip -d casadi

      - name: Set up MATLAB
        uses: matlab-actions/setup-matlab@v2
        with:
          release: R2025a

      - name: Enable core dumps
        run: |
          # Try to enable core dumps
          ulimit -c unlimited || true
          sudo sysctl kern.coredump=1 || true
          # Check core dump settings
          ulimit -a
          sysctl kern.coredump || true

      - name: Test sysid - let it crash and generate crash report
        uses: matlab-actions/run-command@v2
        continue-on-error: true
        with:
          command: addpath('${{ github.workspace }}/casadi'); cd('casadi_src/docs/examples/matlab'); sysid

      - name: Collect crash info
        if: always()
        run: |
          echo "=== Core dumps ==="
          ls -la /cores/ 2>/dev/null || echo "No /cores directory"
          find /cores -name "core.*" 2>/dev/null | head -5 || true

          echo ""
          echo "=== Recent crash reports (full) ==="
          # Get user crash reports (may have better access)
          find ~/Library/Logs/DiagnosticReports -type f -mmin -30 2>/dev/null || true

          # Get system crash reports
          find /Library/Logs/DiagnosticReports -type f -mmin -30 2>/dev/null | while read f; do
            echo ""
            echo "====== $f ======"
            cat "$f" 2>/dev/null || head -500 "$f" 2>/dev/null || echo "Could not read $f"
          done

          echo ""
          echo "=== Check for any crash logs ==="
          ls -la ~/Library/Logs/DiagnosticReports/ 2>/dev/null || true
          ls -la /Library/Logs/DiagnosticReports/ 2>/dev/null || true
