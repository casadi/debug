name: Test CasADi

on:
  push:
  workflow_dispatch:

jobs:
  test-matlab-macos-arm64:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4.1.1

      - name: Clone CasADi repo
        run: git clone --depth 1 https://github.com/casadi/casadi.git casadi_src

      - name: Download CasADi nightly
        run: |
          wget https://github.com/casadi/casadi/releases/download/nightly-main/casadi-main-osx-arm64-matlab2018b.zip -O casadi.zip

      - name: Unpack
        run: unzip casadi.zip -d casadi

      - name: Set up MATLAB
        uses: matlab-actions/setup-matlab@v2
        with:
          release: R2025a

      - name: Hack lldb - replace system lldb with wrapper
        run: |
          # Create wrapper that auto-runs and prints backtrace on crash
          cat > /tmp/lldb_wrapper << 'WRAPPER'
          #!/bin/bash
          exec /usr/bin/lldb.real -o "run" -k "thread backtrace all" -k "quit 1" "$@"
          WRAPPER
          chmod +x /tmp/lldb_wrapper
          # Replace system lldb
          sudo mv /usr/bin/lldb /usr/bin/lldb.real
          sudo cp /tmp/lldb_wrapper /usr/bin/lldb
          sudo chmod +x /usr/bin/lldb

      - name: Test sysid with lldb
        uses: matlab-actions/run-command@v2
        with:
          command: addpath('${{ github.workspace }}/casadi'); cd('casadi_src/docs/examples/matlab'); sysid
          startup-options: -Dlldb

      - name: Collect crash info
        if: always()
        run: |
          echo "=== Check lldb wrapper ==="
          cat /usr/bin/lldb
          which lldb
          echo "=== Core dumps ==="
          find /cores -name "core.*" 2>/dev/null | head -5 || true
          echo "=== Recent crash reports ==="
          find /Library/Logs/DiagnosticReports -type f -mmin -10 2>/dev/null | head -10 | xargs -I{} sh -c 'echo "=== {} ===" && head -300 "{}"' || true
